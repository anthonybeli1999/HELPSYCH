
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Chat | Home</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="A high-quality &amp; free Bootstrap admin dashboard template pack that comes with lots of templates and components.">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" id="main-stylesheet" data-version="1.1.0" href="~/styles/shards-dashboards.1.1.0.min.css">
    <link rel="stylesheet" href="~/styles/extras.1.1.0.min.css">
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <link rel="stylesheet" type="text/css" href="~/plugins/fa/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="~/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
    <script type="text/javascript" src="~/plugins/jquery.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-firestore.js"></script>


</head>
<body>
    <header class="top-head">
        <button class="logout cus-btn cus-btn-blue">SALIR DE LA SESION Y REGRESAR AL INICIO</button>
        <br />&nbsp;&nbsp;<a href="~/Home/Articulos" class="btn btn-success">Ver Articulos</a>
    </header>

    <div class="main-content-container container-fluid px-4">
        <!-- Page Header -->
        <div class="page-header row no-gutters py-4">
            <div class="col-12 col-sm-4 text-center text-sm-left mb-0">
                <span class="text-uppercase page-subtitle">Components</span>
                <h3 class="page-title">Chat</h3>
            </div>
        </div>
        <!-- End Page Header -->
        <article>

  
                <div  class="card card-small mb-3">

                    <div class="text-right">

                        <a href="~/Home/especialistas" class="btn btn-lg btn-secondary">Volver Atras</a>
                    </div>

                    <div class="col-sm-12 col-md-8 col-lg-8">

                        
                            <div class="chat-messages">
                                <div class="chat-messages-head">
                                    <div class="cmh-wrap">
                                        <span class="messages-with-name">HELPSYCH APOYO EMOCIONAL<span>-</span></span>
                                    </div>
                                </div>
                                <div id="frame">
                                    <div class="content">
                                        <div class="messages" id="chatBox">
                                            <ul>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="files-list">
                                    <span class="close-files-list"> <i class="fa fa-close"></i> </span>
                                </div>

                                <form method="POST" id="type-text-form">
                                    <div class="send-mess">
                                        <div class="add-items">
                                            <label for="share-file">+</label>
                                            <input type="file" name="" id="share-file" multiple>
                                        </div>
                                        <div class="type-text">
                                            <textarea placeholder="Type Message..." id="typed-text" name="typed-text" required></textarea>
                                        </div>
                                        <div class="send-text">
                                            <button type="submit"> <img src="~/assets/send.svg"> </button>
                                        </div>

                                    </div>
                                </form>



                            </div>

                      

                    </div>


                </div>
            
        </article>

    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

    <script src="//cdn.ckeditor.com/4.5.10/standard/ckeditor.js"></script>

    <script>
        // firebase config
        var config = {
            apiKey: "AIzaSyCCilUA5-Pu1LafwsvbyD3HBchsKE1oqTY",
            authDomain: "helpsych-66739.firebaseapp.com",
            databaseURL: "https://helpsych-66739-default-rtdb.firebaseio.com",
            projectId: "helpsych-66739",
            storageBucket: "helpsych-66739.appspot.com",
            messagingSenderId: "529615864029"
        };
        firebase.initializeApp(config);

        /////////////////////////////////////

        /*********************************\
         * Fetch and display the entry *
        \*********************************/

        var entry_id = $_GET('id');

        if (entry_id) {

            var added_views = false;
            var Entry = firebase.database().ref('Users').child(entry_id);

            Entry.on('value', function (r) {
                var entry = r.val();

                if (entry) {

                    entry['updatedAt-formatted'] = datetimeFormat(entry.updatedAt);

                    $('[data-bind]').each(function () {
                        $(this).html(entry[$(this).data('bind')]);
                    });

                    // update title


                    // increase views count. once.
                    //if (!added_views) {
                    //    added_views = true;
                    //    Entry.child('views').transaction(function (views) {
                    //        return (views || 0) + 1;
                    //    });
                    //}

                } else { // content not found
                    alert('Please login first')
                    window.location.href = 'login';
                }

            });

            // update button
            $('#update').attr('href', '/Articulos/updatechat?id=' + entry_id);

            // delete button
            $('#delete').click(function () {
                if (confirm('This entry will be permanently delete. Are you sure?')) {
                    Entry.remove(); // this will trigger Entry.on('value') immediatly
                }
            });
        } else {
            alert('This entry id does not exist');
            window.location.href = 'login';
        }

        /*************\
         * Utilities *
        \*************/

        function $_GET(key) {
            var queries = window.location.href.split('?').pop().split('&');
            var params = {};
            queries.map(function (query) {
                var set = query.split('=');
                params[set[0]] = set[1];
            });

            if (key) {
                return params[key] || null;
            } else {
                return params;
            }

        }

        function pad2Digit(num) {
            return ('0' + num.toString()).slice(-2);
        }

        function datetimeFormat(timestamp) {
            var dateObj = new Date(timestamp);
            var en_month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return dateObj.getDate() + ' ' + en_month[dateObj.getMonth()] + ' ' + pad2Digit(dateObj.getFullYear()) + ' ' + pad2Digit(dateObj.getHours()) + ':' + pad2Digit(dateObj.getMinutes());
        }


        $(".messages").animate({ scrollTop: $(document).height() }, "fast");
        var user_id;

        function newMessage() {

            message = $(".type-text textarea").val();
            if ($.trim(message) == '') {
                return false;
            }
            writeUserData(message);
        };

        function MostrarMensaje() {

            message = $(".type-text textarea").val();
            if ($.trim(message) == '') {
                return false;
            }
            Mostrar(message);
        };

        $('.send-text').click(function () {
            newMessage();
            return false;
        });

        $('.send-text').click(function () {
            MostrarMensaje();
            return false;
        });

        $(window).on('keydown', function (e) {

            if (e.which == 13) {
                newMessage();
                return false;
            }
        });




        var user = firebase.auth().signInAnonymously();

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                // User is signed in.
                var isAnonymous = user.isAnonymous;
                user_id = user.uid;

            } else {
                // User is signed out.
            }
        });

        const usuari2 = 'ZRXaGXqLEec8VobrTAhD0bkseP92';

        const usuari1 = 'W0YcVuiJvCbJJNmN0lMkqrjcVly2';



        // AGREGAR MENSAJES AL CHAT


        function Mostrar(message) {


            var USUARIO = firebase.auth().currentUser.uid;

            var db_usuario = firebase.database().ref('Messages').child(USUARIO).child(entry_id);

            db_usuario.on('child_added', function (data) {
                var type;
                if (data.val().user_id == user_id) {
                    type = "sent";
                }
                else {
                    type = "replies";
                }
                $('<li class="' + type + '"><p>' + data.val().message + '</p></li>').appendTo($('.messages ul'));
                $('.type-text textarea').val(null);
                $('.contact.active .preview').html('<span>You: </span>' + data.val().message);

                $(".messages").animate({ scrollTop: $(".messages")[0].scrollHeight }, 0);
            });


        }



        function writeUserData(message) {

            var USERPRUEBA = firebase.auth().currentUser.uid;
            var db_ref0 = firebase.database().ref('Messages').child(USERPRUEBA).child(entry_id);


            var key = db_ref0.push().key;

            var db_ref3 = firebase.database().ref('Messages').child(USERPRUEBA).child(entry_id);
            var db_ref4 = firebase.database().ref('Messages').child(entry_id).child(USERPRUEBA);



            db_ref3.child(key).update({
                user_id: user_id,
                from: USERPRUEBA,
                message: message,
                date: 'jun.14, 2021',
                messageID: key,
                time: '09.47 p.m',
                to: entry_id,
                type: 'text',

            });

            db_ref4.child(key).update({
                user_id: user_id,
                from: entry_id,
                message: message,
                date: 'jun.14, 2021',
                messageID: key,
                time: '09.47 p.m',
                to: USERPRUEBA,
                type: 'text',

            });


        }




    </script>


</body>

</html>