
@{
    ViewBag.Title = "Prueba";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Static Template</title>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css" />
    <script defer
            src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-database.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->

    <script>
        // Your web app's Firebase configuration
        var nextkey = 0;
        var firebaseConfig = {
            apiKey: "AIzaSyCCilUA5-Pu1LafwsvbyD3HBchsKE1oqTY",
            authDomain: "helpsych-66739.firebaseapp.com",
            databaseURL: "https://helpsych-66739-default-rtdb.firebaseio.com",
            projectId: "helpsych-66739",
            storageBucket: "helpsych-66739.appspot.com",
            messagingSenderId: "529615864029",
            appId: "1:529615864029:web:58f450812847a0a7a3db34"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        database.ref("Article").on("child_added", function (data) {
            add_data_table(
                data.val().author,
                data.val().image,
                data.val().body,
                data.key
            );
            var lastkey = data.key;
            nextkey = parseInt(lastkey) + 1;
        });
        database.ref("Article").on("child_changed", function (data) {
            update_data_table(
                data.val().author,
                data.val().image,
                data.val().body,
                data.key
            );
        });
        database.ref("Article").on("child_removed", function (data) {
            remove_data_table(data.key);
        });
    </script>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title">
                Lista de Articulos
            </h1>
            <div class="content">
                <button id="btnAdd" class="button">
                    <i class="fa fa-plus"></i>  Agregar Articulos
                </button>
            </div>
            <div id="card-list" class="columns is-mobile"></div>
        </div>
        <div id="modal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Person Form</p>
                    <button class="btnClose delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">
                    <div class="field">
                        <label class="label">Autor de Articulo</label>
                        <div class="control">
                            <input type="hidden" id="txtType" />
                            <input type="hidden" id="txtKey" />
                            <input class="input"
                                   id="txtName"
                                   type="text"
                                   placeholder="Autor de Articulo" />
                        </div>
                        <p class="help"></p>
                    </div>
                    <div class="field">
                        <label class="label">Texto de Articulo</label>
                        <div class="control">
                            <input class="input"
                                   id="txtTexto"
                                   type="text"
                                   placeholder="Texto de Articulo" />
                        </div>
                        <p class="help"></p>
                    </div>
                    <div class="field">
                        <label class="label">Imagen de Articulo</label>
                        <div class="control">
                            <input class="input"
                                   id="txtPic"
                                   type="text"
                                   placeholder="Imagen de Articulo" />
                        </div>
                        <div class="form-group text-center">
                            <input id="btnUpload" type="file" class="btn btn-primary" accept="image/*" />
                        </div>
                        <p class="help"></p>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button id="btnSave" class="button is-success">Save changes</button>
                    <button id="btnClose" class="button">Cancel</button>
                </footer>
            </div>
        </div>
    </section>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous">

    </script>

    <script>
        $("#btnUpload").change(function () {
            file = document.getElementById("btnUpload").files[0];
            fileName = file.name;
            storageRef = firebase.storage().ref(storageFolder + fileName);
            uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', function (snapshot) {


            }, function (error) {
                console.log("Error uploadTask " + error)
            }, function () {
                downloadURL = uploadTask.snapshot.downloadURL;
                console.log("URL de la imagen:" + downloadURL);
                $("#btnUpload").addClass("btn-success");
                $("#btnSend").removeClass("disabled").click(sendData);
            });
        })
    </script>





    <script>
      function getData() {
        database
            .ref("/Article/")
          .once("value")
          .then(
            function(snapshot) {
              let object = snapshot.val();
              let array = Object.keys(object);
              $(".result").html("");
              array.forEach(key => {
                $(".result").append(card(object[key]));
              });
            },
            function(error) {
              if (error) {
                console.log("write error : ", error);
              } else {
                console.log("successfully");
              }
            }
          );
      }

      function add_data_table(name, pic, text, key) {
        $("#card-list").append(
          '<div class="column is-3" id="' +
            key +
            '"><div class="card"><div class="card-image"><figure class="image is-4by3"><img src="' +
            pic +
            '"></figure></div><div class="card-content"><div class="media"><div class="media-content"><p class="title is-4">' +
            name +
            '</p><p class="subtitle is-6">' +
            text +
            '</p></div></div></div><footer class="card-footer"><a href="#" data-key="' +
            key +
            '" class="card-footer-item btnEdit">Edit</a><a href="#" class="card-footer-item btnRemove"  data-key="' +
            key +
            '">Remove</a></footer></div></div>'
        );
      }
        function update_data_table(name, pic, text, key) {
        $("#card-list #" + key).html(
          '<div class="card"><div class="card-image"><figure class="image is-4by3"><img src="' +
            pic +
            '"></figure></div><div class="card-content"><div class="media"><div class="media-content"><p class="title is-4">' +
            name +
            '</p><p class="subtitle is-6">' +
            text +
            '</p></div></div></div><footer class="card-footer"><a href="#" class="card-footer-item btnEdit"  data-key="' +
            key +
            '">Edit</a><a  data-key="' +
            key +
            '" href="#" class="card-footer-item btnRemove">Remove</a></footer></div>'
        );
      }
      function remove_data_table(key) {
        $("#card-list #" + key).remove();
      }
      function new_data(name, text, pic, key) {
          database.ref("Article/" + key).set({
          author: name,
          body: text,
              image: pic
        });
      }
      function update_data(name, text, pic, key) {
          database.ref("Article/" + key).update({
              author: name,
              body: text,
              image: pic
        });
      }
      $("#btnAdd").click(function() {
        $("#txtName").val("");
        $("#txtTexto").val("");
        $("#btnUpload").val("");
        $("#txtType").val("N");
        $("#txtKey").val("0");
        $("#modal").addClass("is-active");
      });
      $("#btnSave").click(function() {
        if ($("#txtType").val() == "N") {
          database
              .ref("Article")
            .once("value")
            .then(function(snapshot) {
              if (snapshot.numChildren() == 0) {
                nextkey = 1;
              }
              new_data(
                $("#txtName").val(),
                $("#txtTexto").val(),
                $("#btnUpload").val(),
                nextkey
              );
            });
        } else {
          update_data(
            $("#txtName").val(),
            $("#txtTexto").val(),
            $("#btnUpload").val(),
            $("#txtKey").val()
          );
        }
        $("#btnClose").click();
      });
      $(document).on("click", ".btnEdit", function(event) {
        event.preventDefault();
        key = $(this).attr("data-key");
        database
            .ref("Article/" + key)
          .once("value")
          .then(function(snapshot) {
            $("#txtName").val(snapshot.val().username);
            $("#txtTexto").val(snapshot.val().email);
              $("#btnUpload").val(snapshot.val().profile_picture);
            $("#txtType").val("E");
            $("#txtKey").val(key);
          });
        $("#modal").addClass("is-active");
      });
      $(document).on("click", ".btnRemove", function(event) {
        event.preventDefault();
        key = $(this).attr("data-key");
        database.ref("Article/" + key).remove();
      });

      $("#btnClose,.btnClose").click(function() {
        $("#modal").removeClass("is-active");
      });
    </script>
</body>
</html>
